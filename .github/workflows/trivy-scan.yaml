on:
  workflow_call:
    inputs:
      projectDir:
        required: false
        type: string
        default: .
        description: path of the project to scan, relative to the root of the repository
      trivyVersion:
        required: false
        type: string
        default: "0.58.1"
        description: Trivy version to install
      addPullRequestComment:
        required: false
        type: boolean
        default: true
        description: add scan results as a PR comment
      trivyIgnoreFile:
        required: false
        type: string
        default: .trivyignore
        description: path to .trivyignore file for excluding vulnerabilities (ignored if file does not exist)
      configFile:
        required: false
        type: string
        default: trivy.yaml
        description: path to trivy.yaml configuration file (ignored if file does not exist)
      ignoreErrors:
        required: false
        type: boolean
        default: false
        description: whether or not to ignore errors

jobs:
  trivy-scan:
    name: Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write # needed for PR comments
      statuses: write # needed for setting the status of the PR
    env:
      CHECK_NAME: Trivy CI

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Set pending status
        if: github.event_name == 'pull_request' || github.event_name == 'pull_request_target'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api --method POST -H "Accept: application/vnd.github+json" -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/statuses/${{ github.event.pull_request.head.sha }} \
            -f "state=pending" -f "description=security scan running" \
            -f "context=${{ env.CHECK_NAME }}"

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin v${{ inputs.trivyVersion }}
          trivy --version

      - name: Build Trivy command arguments
        id: trivy-args
        run: |
          ARGS=""

          # Only add ignorefile if the file exists
          if [ -n "${{ inputs.trivyIgnoreFile }}" ] && [ -f "${{ inputs.trivyIgnoreFile }}" ]; then
            echo "Using ignore file: ${{ inputs.trivyIgnoreFile }}"
            ARGS="$ARGS --ignorefile ${{ inputs.trivyIgnoreFile }}"
          elif [ -n "${{ inputs.trivyIgnoreFile }}" ]; then
            echo "Ignore file not found: ${{ inputs.trivyIgnoreFile }} (skipping)"
          fi

          # Only add config file if the file exists
          if [ -n "${{ inputs.configFile }}" ] && [ -f "${{ inputs.configFile }}" ]; then
            echo "Using config file: ${{ inputs.configFile }}"
            ARGS="$ARGS --config ${{ inputs.configFile }}"
          elif [ -n "${{ inputs.configFile }}" ]; then
            echo "Config file not found: ${{ inputs.configFile }} (skipping)"
          fi

          echo "args=$ARGS" >> $GITHUB_OUTPUT

      - name: Run Trivy scan (table output)
        id: trivy-table
        continue-on-error: true
        run: |
          trivy fs \
            --format table \
            --output trivy-results.txt \
            ${{ steps.trivy-args.outputs.args }} \
            ${{ inputs.projectDir }}


      - name: Generate PR comment body
        if: always() && (github.event_name == 'pull_request' || github.event_name == 'pull_request_target') && inputs.addPullRequestComment
        id: comment-body
        run: |
          {
            echo 'body<<EOF'
            echo "## Trivy Security Scan Results"
            echo ""
            if [ "${{ steps.trivy-table.outcome }}" == "success" ]; then
              echo "> [!NOTE]"
              echo "> No vulnerabilities found"
            else
              echo "> [!WARNING]"
              echo "> Vulnerabilities detected"
              echo ""
              echo "<details>"
              echo "<summary>Click to expand scan results</summary>"
              echo ""
              echo '```'
              # Limit output to prevent massive comments (last 500 lines)
              if [ -f trivy-results.txt ]; then
                tail -n 500 trivy-results.txt
              else
                echo "No results file generated"
              fi
              echo '```'
              echo ""
              echo "</details>"
            fi
            echo ""
            echo "---"
            echo "*Scan performed by [Trivy](https://github.com/aquasecurity/trivy) v${{ inputs.trivyVersion }}*"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Comment PR with scan results
        if: always() && (github.event_name == 'pull_request' || github.event_name == 'pull_request_target') && inputs.addPullRequestComment
        uses: thollander/actions-comment-pull-request@24bffb9b452ba05a4f3f77933840a6a841d1b32b # v3
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          mode: recreate
          comment-tag: trivy-scan-results
          create-if-not-exists: true
          message: ${{ steps.comment-body.outputs.body }}

      - name: Upload scan results as artifact
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: trivy-scan-results
          path: trivy-results.txt
          retention-days: 30
          if-no-files-found: ignore

      - name: Set status success
        if: (success() || inputs.ignoreErrors == true) && (github.event_name == 'pull_request' || github.event_name == 'pull_request_target')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api --method POST -H "Accept: application/vnd.github+json" -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/statuses/${{ github.event.pull_request.head.sha }} \
            -f "state=success" -f "description=security scan passed" \
            -f "context=${{ env.CHECK_NAME }}"

      - name: Set status failure
        if: failure() && inputs.ignoreErrors == false && (github.event_name == 'pull_request' || github.event_name == 'pull_request_target')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api --method POST -H "Accept: application/vnd.github+json" -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/statuses/${{ github.event.pull_request.head.sha }} \
            -f "state=failure" -f "description=security vulnerabilities found" \
            -f "context=${{ env.CHECK_NAME }}"

      - name: Fail if vulnerabilities found
        if: steps.trivy-table.outcome == 'failure' && inputs.ignoreErrors == false
        run: exit 1
